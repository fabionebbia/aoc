Needs refactoring.
Took ~110 minutes to complete on my machine.